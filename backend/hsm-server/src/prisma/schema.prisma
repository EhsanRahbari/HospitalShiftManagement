// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/client"
}

datasource db {
  provider = "postgresql"
}

// ===============================
// ENUMS
// ===============================

enum Role {
  ADMIN
  DOCTOR
  NURSE
}

enum SelectionType {
  ADMIN_ASSIGNED
  USER_SELECTED
}

enum ShiftType {
  REGULAR
  OVERTIME
  ON_CALL
  EMERGENCY
}

enum ShiftStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ConventionType {
  AVAILABILITY
  RESTRICTION
  LEGAL
  MEDICAL
  CUSTOM
}

// ===============================
// MODELS
// ===============================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(NURSE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit Trail
  createdById String?
  createdBy   User?   @relation("UserCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("UserCreator")

  department String?
  section    String?

  // Relations
  shifts              Shift[]
  userConventions     UserConvention[]
  createdConventions  Convention[]      @relation("ConventionCreator")
  assignedConventions UserConvention[]  @relation("ConventionAssigner")
  
  // ⬇️ NEW: Shift assignments
  shiftAssignments       ShiftAssignment[]
  createdShiftAssignments ShiftAssignment[] @relation("AssignmentCreator")


  sentMessages         Message[]          @relation("SentMessages")       
  receivedMessages     MessageRecipient[] @relation("ReceivedMessages")  

  @@map("users")
}

model Shift {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  startTime   DateTime
  endTime     DateTime
  description String?
  shiftType   ShiftType   @default(REGULAR)
  status      ShiftStatus @default(SCHEDULED)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // ⬇️ NEW: Assignments relation
  assignments ShiftAssignment[]

  @@index([userId])
  @@index([startTime])
  @@map("shifts")
}

model Convention {
  id          String         @id @default(uuid())
  title       String
  description String?
  type        ConventionType @default(CUSTOM)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  createdById String?
  createdBy   User?   @relation("ConventionCreator", fields: [createdById], references: [id], onDelete: SetNull)

  userConventions UserConvention[]

  @@map("conventions")
}

model UserConvention {
  id           String        @id @default(uuid())
  userId       String
  conventionId String
  assignedAt   DateTime      @default(now())
  selectionType SelectionType @default(USER_SELECTED)

  assignedById String?
  assignedBy   User?   @relation("ConventionAssigner", fields: [assignedById], references: [id], onDelete: SetNull)

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  convention Convention @relation(fields: [conventionId], references: [id], onDelete: Cascade)

  @@unique([userId, conventionId])
  @@index([userId])
  @@index([conventionId])
  @@index([selectionType])
  @@map("user_conventions")
}

// ⬇️ NEW: ShiftAssignment Model
model ShiftAssignment {
  id        String   @id @default(uuid())
  userId    String
  shiftId   String
  date      DateTime // The specific date this shift is assigned
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit Trail: Track who created this assignment
  createdById String?
  createdBy   User?   @relation("AssignmentCreator", fields: [createdById], references: [id], onDelete: SetNull)

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  // Allow multiple shifts per day (different shifts)
  @@unique([userId, shiftId, date])
  @@index([userId])
  @@index([shiftId])
  @@index([date])
  @@map("shift_assignments")
}


model Message {
  id                String              @id @default(uuid())
  title             String
  content           String              @db.Text
  senderId          String              @map("sender_id")
  sender            User                @relation("SentMessages", fields: [senderId], references: [id])
  targetDepartments String[]            @map("target_departments") // Array of department names
  targetSections    String[]            @map("target_sections") // Array of section names
  recipients        MessageRecipient[]
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  @@map("messages")
}

model MessageRecipient {
  id         String    @id @default(uuid())
  messageId  String    @map("message_id")
  message    Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId     String    @map("user_id")
  user       User      @relation("ReceivedMessages", fields: [userId], references: [id], onDelete: Cascade)
  readAt     DateTime? @map("read_at")
  receivedAt DateTime  @default(now()) @map("received_at")

  @@unique([messageId, userId]) // Prevent duplicate messages to same user
  @@map("message_recipients")
}